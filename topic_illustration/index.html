<!DOCTYPE html>
<meta charset="utf-8">
<style>

body {
    font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
    margin: auto;
    position: relative;
    width: 960px;
}

form {
    position: absolute;
    right: 10px;
    top: 10px;
}

</style>
<body>
    <div id=topic_sunburst></div>
</body>
<script src="https://d3js.org/d3.v3.min.js"></script>
<script>

var width = 960,
height = 700,
radius = (Math.min(width, height) / 2) - 10;

var formatNumber = d3.format(",d");

var x = d3.scale.linear()
.range([0, 2 * Math.PI]);

var y = d3.scale.linear()  // use linear scale to make the center spot smaller
.range([0, radius]);

var color = d3.scale.category20c();

var partition = d3.layout.partition()
.value(function(d) { return d.size; })
.sort(function (a,b){return d3.ascending(a.name,b.name);});  // organize by name

var arc = d3.svg.arc()
.startAngle(function(d) { return Math.max(0, Math.min(2 * Math.PI, x(d.x))); })
.endAngle(function(d) { return Math.max(0, Math.min(2 * Math.PI, x(d.x + d.dx))); })
.innerRadius(function(d) { return Math.max(0, y(d.y)); })
.outerRadius(function(d) { return Math.max(0, y(d.y + d.dy)); });

var svg = d3.select("#topic_sunburst").append("svg")
.attr("width", width)
.attr("height", height)
.append("g")
.attr("transform", "translate(" + width / 2 + "," + (height / 2) + ")");

svg.selectAll('text')
.append('text')
.text('SfN 2016 conference abstract by topic')
.append("g")
.attr("x",50)
.attr("y",50)
.style('stroke','black');

d3.json("topic_tree.json", function(error, root) {
    if (error) throw error;

    // get partition object from the tree stucture, key for this plot
    data_partition = partition.nodes(root);

    // calculate color
    data_partition.forEach(function (d){
        if (d.name=='root'){d.hue = 180;}
        else if (d.parent.name=='root') {d.hue = (d.x+d.dx/2-d.parent.x)/d.parent.dx*360;}
        else {d.hue = (d.name=='root' ? 180 : ( (d.x+d.dx/2-d.parent.x)/d.parent.dx*360)+ 3*d.parent.hue )/4;}
    })

    // console.log(data_partition)

    var g = svg.selectAll("g")
    .data(data_partition)
    .enter().append("g");

    var path = g.append("path")
    .attr("d", arc)
    //.style("fill", function(d) { return color((d.children ? d : d.parent).name); })
    .style("fill", function(d) {
        return d.name=='root' ? '#d0d0d0' : d3.hsl( d.hue, (1-d.y)*0.9+0.1, 0.5);
    })  // color scheme so that parant and children share similar hue
    .style("stroke", "#fff")
    //.style("fill-rule", "evenodd")
    .on("click", click)
    .append("title")
    .text(function(d) { return d.name + "\n" + formatNumber(d.value); });

    // var text = g.append("text")
    // .attr("transform", function(d) { return "rotate(" + computeTextRotation(d) + ")"; })
    // .attr("x", function(d) { return y(d.y); })
    // .attr("dx", "6") // margin
    // .attr("dy", ".35em") // vertical-align
    // .text(function(d) { return d.dx<5/360 ? '': d.name; })
    // .style('font-size', '12px');

});

function click(d) {
    svg.transition()
    .duration(750)
    .tween("scale", function() {
        var xd = d3.interpolate(x.domain(), [d.x, d.x + d.dx]),
        yd = d3.interpolate(y.domain(), [d.y, 1]),
        yr = d3.interpolate(y.range(), [d.y ? 20 : 0, radius]);
        return function(t) { x.domain(xd(t)); y.domain(yd(t)).range(yr(t)); };
    })
    .selectAll("path")
    .attrTween("d", function(d) { return function() { return arc(d); }; });
}

function computeTextRotation(d) {
  return (x(d.x + d.dx / 2) - Math.PI / 2) / Math.PI * 180;
}

d3.select(self.frameElement).style("height", height + "px");

</script>
